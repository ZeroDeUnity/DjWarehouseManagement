<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="@Url.Content("~/Scripts/newWeb/assets/img/favicon.ico")">
    <link rel="icon" type="image/png" href="@Url.Content("~/Scripts/newWeb/assets/img/favicon.ico")">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>新增入库</title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css?family=Nunito:300,300i,400,600,800" rel="stylesheet">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">


    <!-- Main CSS -->
    <link href="@Url.Content("~/Scripts/newWeb/assets/css/main.css")" rel="stylesheet" />

    <!-- Animation CSS -->
    <link href="@Url.Content("~/Scripts/newWeb/assets/css/vendor/aos.css")" rel="stylesheet" />
    <link href="@Url.Content("~/Scripts/bootstrap-table-master/dist/bootstrap-table.css")" rel="stylesheet" />

    <!-- App favicon -->
    <link href="@Url.Content("~/Scripts/newWeb2/assets/images/favicon.ico")" rel="stylesheet" />

    <!-- Daterangepicker css -->
    <link href="@Url.Content("~/Scripts/newWeb2/assets/vendor/daterangepicker/daterangepicker.css")" rel="stylesheet" />

    <!-- Vector Map css -->
    <link href="@Url.Content("~/Scripts/newWeb2/assets/vendor/admin-resources/jquery.vectormap/jquery-jvectormap-1.2.2.css")" rel="stylesheet" />

    <!-- Theme Config Js -->
    <script src="@Url.Content("~/Scripts/newWeb2/assets/js/config.js")" type="text/javascript"></script>

    <link href="@Url.Content("~/Scripts/newWeb2/assets/css/app.css?v=1.1.1")" rel="stylesheet" type="text/css" id="app-style" />

    <!-- Icons css -->
    <link href="@Url.Content("~/Scripts/newWeb2/assets/css/icons.css")" rel="stylesheet" type="text/css" />

    <!-- 引入 Select2 CSS -->
    <link href="@Url.Content("~/Content/select2.css")" rel="stylesheet" type="text/css" />

    <style>
        html, body {
            height: 100%;
        }
    </style>
</head>

<body>

    <main id="main01" @*class="container"*@>

        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0 p-2 bg-light-subtle">
                            <li class="breadcrumb-item"><a href="javascript:void(0);"><i class="ri-home-4-line"></i> 主页</a></li>
                            <li class="breadcrumb-item"><a href="/ProductEntry/Index?dateInput=@ViewBag.dateInput">产品入库</a></li>
                            <li class="breadcrumb-item active" aria-current="page"><a href="javascript:void(0);">新增入库</a></li>
                        </ol>
                    </nav>
                </div>
                <div class="card-body">
                    <form class="needs-validation" novalidate>
                        <div class="mb-2">
                            <label for="selectProductType" class="form-label">产品类别:</label>
                            <div class="row">
                                <div class="col-sm-4">
                                    <!-- 在下面添加一个下拉框,选择项有正品,B级布,默认是正品 -->
                                    <select class="form-select" id="selectProductType" required>
                                        <option value="正品">正品</option>
                                        <option value="B级品">B级品</option>
                                    </select>
                                    <div class="valid-feedback">
                                        验证通过~
                                    </div>
                                    <div class="invalid-feedback">
                                        该字段不能为空!
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-2">
                            <label for="selectProduct" class="form-label">选择产品:</label>
                            <div class="row">
                                <div class="col-sm-4">
                                    <!-- 下拉框,动态输入搜索结果出现选项 -->
                                    <select class="form-select" id="selectProduct" style="width: 100%;" required>
                                    </select>
                                    <div class="valid-feedback">
                                        验证通过~
                                    </div>
                                    <div class="invalid-feedback">
                                        该字段不能为空!
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-2">
                            <label for="actualSize" class="form-label">实际码数:</label>
                            <div class="row">
                                <div class="col-sm-4">
                                    <!-- 在下面是输入框,输入数字 -->
                                    <input type="number" class="form-control" id="actualSize" placeholder="请输入实际码数" required>
                                    <div class="valid-feedback">
                                        验证通过~
                                    </div>
                                    <div class="invalid-feedback">
                                        该字段不能为空!
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-2">
                            <label for="quantity" class="form-label">入库数量:</label>
                            <div class="row">
                                <div class="col-sm-4">
                                    <!-- 在下面是输入框,输入数字 -->
                                    <input type="number" class="form-control" id="quantity" placeholder="请输入入库数量" required>
                                    <div class="valid-feedback">
                                        验证通过~
                                    </div>
                                    <div class="invalid-feedback">
                                        该字段不能为空!
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-2">
                            <label for="selectExplain" class="form-label">存放方式:</label>
                            <div class="row">
                                <div class="col-sm-4">
                                    <!-- 在下面添加一个下拉框,选择项有货架堆放,货架附近堆放,即将出库,临时堆放,默认是货架堆放 -->
                                    <select class="form-select" id="selectExplain" style="width: 100%;" required>
                                        <option value="货架堆放">货架堆放</option>
                                        <option value="货架附近堆放">货架附近堆放</option>
                                        <option value="即将出库,临时堆放">即将出库,临时堆放</option>
                                    </select>
                                    <div class="valid-feedback">
                                        验证通过~
                                    </div>
                                    <div class="invalid-feedback">
                                        该字段不能为空!
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="shelfDiv">


                            <div class="mb-2">
                                <label for="shelf" class="form-label">货架:</label>
                                <div class="row">
                                    <div class="col-sm-4">
                                        <select class="form-select" id="shelf" style="width: 100%;" required>
                                        </select>
                                        <div class="valid-feedback">
                                            验证通过~
                                        </div>
                                        <div class="invalid-feedback">
                                            该字段不能为空!
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="shelfLayer" class="span3 form-label">层数:</label>
                                <div class="row">
                                    <div class="col-sm-4">
                                        <select class="form-select" id="shelfLayer" style="width: 100%;" required>
                                            <option value="">-----单选-----</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                        </select>
                                        <div class="valid-feedback">
                                            验证通过~
                                        </div>
                                        <div class="invalid-feedback">
                                            该字段不能为空!
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="form-group" id="nearShelfDiv" style="display:none">

                            <div class="mb-2">
                                <label for="nearShelf1" class="form-label">货架1:</label>
                                <div class="row">
                                    <div class="col-sm-4">
                                        <select class="form-select" id="nearShelf1" style="width: 100%;" required>
                                        </select>
                                        <div class="valid-feedback">
                                            验证通过~
                                        </div>
                                        <div class="invalid-feedback">
                                            该字段不能为空!
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-2">
                                <label for="nearShelf2" class="form-label">货架2:</label>
                                <div class="row">
                                    <div class="col-sm-4">
                                        <select class="form-select" id="nearShelf2" style="width: 100%;" required>
                                        </select>
                                        <div class="valid-feedback">
                                            验证通过~
                                        </div>
                                        <div class="invalid-feedback">
                                            该字段不能为空!
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="mb-2">
                            <div class="row">
                                <div class="col-sm-4">
                                    <label class="span3 form-label" id="shelfDataTitle" style="color:red"></label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-2 mt-5">
                            <button id="Submit_Btn" type="button" class="btn btn-primary mr-3">提交</button>
                            <button id="Back_Btn" type="button" class="btn btn-primary">返回</button>
                        </div>

                    </form>

                </div> <!-- end card-body -->
            </div> <!-- end card-->
        </div>

    </main>

    <label id="ViewBag_BatchId" style="display: none;">@ViewBag.BatchId</label>
    <label id="ViewBag_source" style="display: none;">@ViewBag.source</label>
    <label id="ViewBag_dateInput" style="display: none;">@ViewBag.dateInput</label>

    <!--------------------------------------
    JAVASCRIPTS
    --------------------------------------->

    <script src="@Url.Content("~/Scripts/newWeb/assets/js/vendor/jquery.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/newWeb/assets/js/vendor/popper.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/newWeb/assets/js/vendor/bootstrap.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/newWeb2/assets/vendor/bootstrap/js/bootstrap.bundle.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/newWeb/assets/js/vendor/share.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/newWeb/assets/js/functions.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/bootstrap-table-master/dist/bootstrap-table.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/bootstrap-table-master/dist/extensions/print/bootstrap-table-print.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/bootstrap-table-master/dist/bootstrap-table-locale-all.js")" type="text/javascript"></script>

    <!-- Animation -->
    <script src="@Url.Content("~/Scripts/newWeb/assets/js/vendor/aos.js")" type="text/javascript"></script>

    <script src="@Url.Content("~/Scripts/newWeb2/assets/js/vendor.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/newWeb2/assets/js/app.js")" type="text/javascript"></script>

    <!-- 引入 Select2 JS -->
    <script src="@Url.Content("~/Scripts/select2.js?v=1.1.1")" type="text/javascript"></script>

    <noscript>
        <style>
            *[data-aos] {
                display: block !important;
                opacity: 1 !important;
                visibility: visible !important;
            }
        </style>
    </noscript>
    <script>
        AOS.init({
            duration: 700
        });
    </script>

    <!-- Disable animation on less than 1200px, change value if you like -->
    <script>
        AOS.init({
            disable: function () {
                var maxWidth = 200;
                return window.innerWidth < maxWidth;
            }
        });
    </script>

    <script>
        //设置页面加载完成后事件,更新主页面高度
        const table01 = $('#table01');
        table01.on('load-success.bs.table', function (data) {
            // 表格加载完成后，强制更新滚动容器
            //$('.table-responsive').scrollLeft(0); // 可选：将滚动位置初始化
            // 重设列宽和表格视图
            table01.bootstrapTable('resetView');
            //const height = document.documentElement.scrollHeight;

            //console.log("表格的 HTML 已完全渲染！");
        })
        table01.on('page-change.bs.table', function (data) {
            // 表格加载完成后，强制更新滚动容器
            //$('.table-responsive').scrollLeft(0); // 可选：将滚动位置初始化
            // 重设列宽和表格视图
            table01.bootstrapTable('resetView');
            //const height = document.documentElement.scrollHeight;
            const mainDiv = document.getElementById('main01');
            const height = mainDiv.offsetHeight + 50;
            //alert(height);
            window.parent.postMessage({ type: 'height', value: height }, '*');
            //console.log("表格的 HTML 已完全渲染！");
        })
    </script>

    <script>

        //当前展示批次
        var now_BatchId = $("#ViewBag_BatchId").text();
        //当前展示产品来源
        var now_Source = null;
        //当前订单号
        var now_OrderId = null;
        //当前批次数据ID
        var now_stockId = null;
        //当前选择产品码数
        var now_ProductSize = null;
        //当前产品实际码数
        var now_actualSize = null;
        //当前修改的产品Id
        var now_UpdateProductId = null;
        //当前批次页面状态(新增/修改)
        var now_stockBatchViewStatus = "新增";
        //当前批次数据页面状态(新增/修改)
        var now_stockViewStatus = "新增";
        //当前修改的产品的入库数量
        var now_UpdateProduct_inCount = 0;


        var selectProduct_Data = null;
        var selectShelf_Data = null;
        var selectNearShelf1_Data = null;
        var selectNearShelf2_Data = null;

        function initializeHeight() {
            const mainDiv = document.getElementById('main01');
            const height = mainDiv.offsetHeight + 50;
            //alert(height);
            window.parent.postMessage({ type: 'height', value: height }, '*');
        }

        $(document).ready(function () {



            initializeSelectProduct();

            initializeShelf();

            initializeNearShelf();

            $('#shelfDiv').show();
            $('#nearShelfDiv').hide();

            now_actualSize = null;
            now_ProductSize = null;
            now_UpdateProductId = null;
            $('#selectProductType').val('正品');
            //$('#actualSize').val('');
            $('#quantity').val('');
            $('#selectExplain').val('货架堆放');
            //禁用actualSize
            $('#actualSize').prop('disabled', true);
            //禁用shelfLayer
            $('#shelfLayer').prop('disabled', true);
            $('#shelfLayer').val('1');
            $('#selectProduct').val(null).trigger('change');
            $('#shelf').val(null).trigger('change');
            $('#nearShelf1').val(null).trigger('change');
            $('#nearShelf2').val(null).trigger('change');

            $(".form-select").on("select2:open", function () {
                $(".select2-container--open").css("z-index", 9999);
            });

            //提交表单
            $('#Submit_Btn').click(function () {

                var dateInput = $("#ViewBag_dateInput").text();

                var selectedProductType = $('#selectProductType').val();
                var selectedProduct = $('#selectProduct').val();
                //获取selectProduct的文本
                var selectedProductText = $('#selectProduct').select2('data')[0].text;
                var actualSize = $('#actualSize').val();
                var quantity = $('#quantity').val();
                var selectedExplain = $('#selectExplain').val();
                var shelfIdVal = null;
                var shelfVal = null;
                var shelfLayerVal = null;
                var nearShelf1Val = null;
                var nearShelf1IdVal = null;
                var nearShelf2Val = null;
                var nearShelf2IdVal = null;

                if (selectedExplain === '货架堆放') {
                    // 添加 required 属性，启用验证
                    $('#shelf').attr('required', 'required');
                    $('#shelfLayer').attr('required', 'required');
                    // 移除 required 属性，禁用验证
                    $('#nearShelf1').removeAttr('required');
                    $('#nearShelf2').removeAttr('required');
                } else {
                    // 添加 required 属性，启用验证
                    $('#nearShelf1').attr('required');
                    $('#nearShelf2').attr('required');
                    // 移除 required 属性，禁用验证
                    $('#shelf').removeAttr('required', 'required');
                    $('#shelfLayer').removeAttr('required', 'required');
                }


                //表单验证
                var form_check = false;
                var forms = document.getElementsByClassName('needs-validation');
                // 循环并禁止提交
                var validation = Array.prototype.filter.call(forms, function (form) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                        form_check = false;
                    } else {
                        form_check = true;
                    }
                    form.classList.add('was-validated');
                });

                if (!form_check) {
                    initializeHeight();
                    return;
                }



                if (selectedExplain === '货架堆放') {
                    var shelfId = $('#shelf').val();
                    if (!shelfId) {
                        alert('请检查货架是否正确选择');
                        return;
                    }
                    var shelf = $('#shelf').select2('data')[0].text;
                    shelf = shelf.split(':')[1];
                    var shelfLayer = $('#shelfLayer').val();

                    if (!shelfLayer) {
                        alert('请检查货架是否正确选择');
                        return;
                    }
                    shelfIdVal = shelfId;
                    shelfVal = shelf;
                    shelfLayerVal = shelfLayer;
                } else {
                    var nearShelf1 = $('#nearShelf1').select2('data')[0].text;
                    nearShelf1 = nearShelf1.split(':')[1];
                    var nearShelf1Id = $('#nearShelf1').val();
                    var nearShelf2 = $('#nearShelf2').select2('data')[0].text;
                    nearShelf2 = nearShelf2.split(':')[1];
                    var nearShelf2Id = $('#nearShelf2').val();
                    if (!nearShelf1Id) {

                        return;
                    }
                    if (!nearShelf2Id) {

                        return;
                    }
                    nearShelf1Val = nearShelf1;
                    nearShelf1IdVal = nearShelf1Id;
                    nearShelf2Val = nearShelf2;
                    nearShelf2IdVal = nearShelf2Id;
                }

                var data = {
                    stockId: now_stockId,
                    batchId: now_BatchId,
                    productType: selectedProductType,
                    productId: selectedProduct,
                    productText: selectedProductText,
                    actualSize: actualSize,
                    quantity: quantity,
                    explain: selectedExplain,
                    shelfId: shelfIdVal,
                    shelf: shelfVal,
                    shelfLayer: shelfLayerVal,
                    nearShelf1: nearShelf1Val,
                    nearShelf1Id: nearShelf1IdVal,
                    nearShelf2: nearShelf2Val,
                    nearShelf2Id: nearShelf2IdVal
                };

                // 将JSON数据传给后台处理
                $.ajax({
                    url: '/ProductEntry/AddStockEntryData', // 修改为实际的后端处理路径
                    type: 'POST',
                    data: {
                        dataJson: JSON.stringify(data)
                    },
                    success: function (response) {
                        var data = JSON.parse(response);
                        if (data.status == "success") {
                            var dateInput = $('#ViewBag_dateInput').text().trim();
                            var source = $('#ViewBag_source').text().trim();
                            var BatchId = $('#ViewBag_BatchId').text().trim();
                            window.location.href = "/ProductEntry/Entry_Index?BatchId="
                                + BatchId + "&source=" + source + "&dateInput=" + dateInput;
                            
                        } else {
                            alert('入库数据创建失败，请稍后再试');
                        }
                    },
                    error: function () {
                        alert('请求出错，请稍后再试');
                    }
                });


            });

            // 返回上一页
            $('#Back_Btn').click(function () {
                var dateInput = $('#ViewBag_dateInput').text().trim();
                var source = $('#ViewBag_source').text().trim();
                var BatchId = $('#ViewBag_BatchId').text().trim();
                window.location.href = "/ProductEntry/Entry_Index?BatchId="
                    + BatchId + "&source=" + source + "&dateInput=" + dateInput;
            });

            initializeHeight();
        });

        // 初始化 select2 的函数
        function initializeSelectProduct() {

            var selectProductType_Val = $("#selectProductType").val();
            // 发起 AJAX 请求来获取数据,完成产品数据加载
            $.ajax({
                url: '/ProductEntry/QueryProductInfoByInput',
                type: 'POST',
                async: false,
                data: {
                    selectProductType: selectProductType_Val
                },
                dataType: 'json',
                success: function (data) {

                    var processedData = [];

                    for (var i = 0; i < data.length; i++) {
                        var item = data[i];
                        if (selectProductType_Val == "正品") {
                            var newItem = {
                                id: item.Id,
                                text: item.colorCode + '/' + item.color + '___' + item.process + ' [' + item.size + '码]'
                                //text: item.colorCode + '/' + item.color + ' ' + item.specification + ' ' + item.process + ' [' + item.size + '码]'
                            };
                        } else {
                            var newItem = {
                                id: item.Id,
                                text: item.specification + '___' + item.process + ' [' + item.size + '码]'
                                //text: item.specification + ' ' + item.process + ' [' + item.size + '码]'
                            };
                        }

                        processedData.push(newItem);
                    }
                    selectProduct_Data = processedData;
                    $('#selectProduct').empty();
                    // 数据加载完成后，初始化 select2
                    $('#selectProduct').select2({
                        data: selectProduct_Data, // 使用预加载的数据
                        placeholder: '请选择产品', // 提示文本
                        allowClear: true // 允许清除已选择的选项
                    });

                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error('AJAX 请求失败:', textStatus, errorThrown);
                }
            });

            //$('#selectProduct').val(null).trigger('change');

        }

        // 初始化 货架select2 的函数
        function initializeShelf() {
            // 发起 AJAX 请求来获取数据,完成货架数据加载
            $.ajax({
                url: '/ProductEntry/QueryShelfInfoByInput',
                type: 'POST',
                async: false,
                dataType: 'json',
                success: function (data) {
                    var processedData = [];
                    for (var i = 0; i < data.length; i++) {
                        var item = data[i];
                        var newItem = {
                            id: item.shelfName,
                            text: '货架:' + item.shelfName
                        };
                        processedData.push(newItem);
                    }
                    selectShelf_Data = processedData;
                    // 数据加载完成后，初始化 select2
                    $('#shelf').select2({
                        data: selectShelf_Data, // 使用预加载的数据
                        placeholder: '请选择货架', // 提示文本
                        allowClear: true // 允许清除已选择的选项
                    });
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error('AJAX 请求失败:', textStatus, errorThrown);
                }
            });

            //$('#shelf').val(null).trigger('change');

        }

        // 初始化 货架select2 的函数
        function initializeNearShelf() {

            // 发起 AJAX 请求来获取数据,完成货架数据加载
            $.ajax({
                url: '/ProductEntry/QueryShelfInfoByInput',
                type: 'POST',
                async: false,
                dataType: 'json',
                success: function (data) {
                    var processedData = [];
                    for (var i = 0; i < data.length; i++) {
                        var item = data[i];
                        var newItem = {
                            id: item.Id,
                            text: '货架:' + item.shelfName
                        };
                        processedData.push(newItem);
                    }
                    selectNearShelf1_Data = processedData;
                    selectNearShelf2_Data = processedData;
                    // 数据加载完成后，初始化 select2
                    $('#nearShelf1').select2({
                        data: selectNearShelf1_Data, // 使用预加载的数据
                        placeholder: '请选择货架', // 提示文本
                        allowClear: true // 允许清除已选择的选项
                    });
                    $('#nearShelf2').select2({
                        data: selectNearShelf2_Data, // 使用预加载的数据
                        placeholder: '请选择货架', // 提示文本
                        allowClear: true // 允许清除已选择的选项
                    });
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error('AJAX 请求失败:', textStatus, errorThrown);
                }
            });

            //$('#nearShelf1').val(null).trigger('change');


            //$('#nearShelf2').val(null).trigger('change');


        }

        //下拉框selectProductType 变化后
        $('#selectProductType').change(function () {
            var selectedValue = $(this).val();
            initializeSelectProduct();

            initializeShelf();

            initializeNearShelf();

            $('#actualSize').val('');
            $('#quantity').val('');
            $('#selectExplain').val('货架堆放');
            $('#shelfLayer').val('');
            $('#selectProduct').val(null).trigger('change');
            $('#shelf').val(null).trigger('change');
            $('#nearShelf1').val(null).trigger('change');
            $('#nearShelf2').val(null).trigger('change');

            //queryShelfStatus();

        });

        //下拉框selectExplain 变化后,控制div显示和隐藏
        $('#selectExplain').change(function () {
            var selectedValue = $(this).val();
            if (selectedValue === '货架堆放') {
                $('#shelfDiv').show();
                $('#nearShelfDiv').hide();
            } else {
                $('#shelfDiv').hide();
                $('#nearShelfDiv').show();
            }
            queryShelfStatus();
        });

        //产品选择后,触发事件
        $('#selectProduct').change(function () {
            if ($("#selectProduct").select2('data')[0] != null) {
                var selectProduct_text = $("#selectProduct").select2('data')[0].text;
                var parts = selectProduct_text.split('[');
                now_ProductSize = parts[1].split('码')[0];

                var selectProductId = $('#selectProduct').val();
                if (now_UpdateProductId == selectProductId) {
                    if (now_actualSize != null) {
                        $('#actualSize').val(now_actualSize);
                    } else {
                        $('#actualSize').val(now_ProductSize);
                    }
                } else {
                    $('#actualSize').val(now_ProductSize);
                }

            }
            queryShelfStatus();
        });

        //出货数量变化后,触发事件
        $('#quantity').change(function () {
            queryShelfStatus();
        });

        //实际码数变化后,触发事件
        $('#actualSize').change(function () {
            queryShelfStatus();
        });

        //货架选择后,触发事件
        $('#shelf').change(function () {
            queryShelfStatus();
        });

        //货架层数选择后,触发事件
        $('#shelfLayer').change(function () {
            queryShelfStatus();
        });

        //货架1选择后,触发事件
        $('#nearShelf1').change(function () {
            queryShelfStatus();
        });

        //货架2选择后,触发事件
        $('#nearShelf2').change(function () {
            queryShelfStatus();
        });

        //查询数据库,判断货架堆放状态
        function queryShelfStatus() {
            //清除shelfDataTitle的值
            $('#shelfDataTitle').text("");
            var selectedProduct = $('#selectProduct').val();
            var selectedExplain = $('#selectExplain').val();
            var actualSize = $('#actualSize').val();
            var shelfIdVal = null;
            var shelfVal = null;
            var shelfLayerVal = null;
            var nearShelf1Val = null;
            var nearShelf1IdVal = null;
            var nearShelf2Val = null;
            var nearShelf2IdVal = null;

            if (selectedExplain === '货架堆放') {
                var shelfId = $('#shelf').val();
                var shelf = "";
                if ($('#shelf').select2('data') && $('#shelf').select2('data').length > 0) {
                    shelf = $('#shelf').select2('data')[0].text;
                    shelf = shelf.split(':')[1];
                }
                //var shelf = $('#shelf').select2('data')[0].text;
                //shelf = shelf.split(':')[1];
                var shelfLayer = $('#shelfLayer').val();
                if (!shelfId) {

                    return;
                }
                if (!shelfLayer) {

                    return;
                }
                shelfIdVal = shelfId;
                shelfVal = shelf;
                shelfLayerVal = shelfLayer;
            } else {
                var nearShelf1 = "";
                if ($('#nearShelf1').select2('data') && $('#nearShelf1').select2('data').length > 0) {
                    nearShelf1 = $('#nearShelf1').select2('data')[0].text;
                    nearShelf1 = nearShelf1.split(':')[1];
                }
                //nearShelf1 = nearShelf1.split(':')[1];
                var nearShelf1Id = $('#nearShelf1').val();
                var nearShelf2 = "";
                if ($('#nearShelf2').select2('data') && $('#nearShelf2').select2('data').length > 0) {
                    nearShelf2 = $('#nearShelf2').select2('data')[0].text;
                    nearShelf2 = nearShelf2.split(':')[1];
                }
                //nearShelf2 = nearShelf2.split(':')[1];
                var nearShelf2Id = $('#nearShelf2').val();
                if (!nearShelf1Id) {

                    return;
                }
                if (!nearShelf2Id) {

                    return;
                }
                nearShelf1Val = nearShelf1;
                nearShelf1IdVal = nearShelf1Id;
                nearShelf2Val = nearShelf2;
                nearShelf2IdVal = nearShelf2Id;
            }

            // 数据组装成JSON
            var data = {
                batchId: now_BatchId,
                productId: selectedProduct,
                actualSize: actualSize,
                explain: selectedExplain,
                shelfId: shelfIdVal,
                shelf: shelfVal,
                shelfLayer: shelfLayerVal,
                nearShelf1: nearShelf1Val,
                nearShelf1Id: nearShelf1IdVal,
                nearShelf2: nearShelf2Val,
                nearShelf2Id: nearShelf2IdVal
            };

            //后端查询货架上是否存在产品,如果存在则在标签上提示,告知产品信息,用以辅助提示是否继续入库
            //后端根据多个条件去查询货架产品关联表,看看是否存在产品,如果存在,则可以获取当前货架本产品库存,然后新增货架产品关联信息
            //如果不存在,则新增一条记录,同时也可以获取当前货架本产品库存(为0)
            //这样处理完毕,可以获取货架信息和货架仓位Id,用于入库数据的存储
            //点击入库数据进来后,加载原来的数据信息,如果修改,后端也进行相应的修改
            //修改数据,旧的假删除,或者减去产品数量,再新增新选的产品,和对应的货架信息
            //删除数据,删掉对应的产品入库批次和货架信息
            //用ajax提交数据到后端,方法为QueryShelfStatus
            $.ajax({
                url: '/ProductEntry/QueryShelfProductMappingData', // 后端控制器的路径
                type: 'POST',
                async: false,
                data: {
                    dataJson: JSON.stringify(data)
                },
                success: function (response) {
                    if (response == null) {
                        //alert('查询货架状态失败，请稍后再试。');
                    } else {
                        var shelfDataTitleStr = "当前仓位库存: ";
                        var shelfData = JSON.parse(response);
                        for (var i = 0; i < shelfData.length; i++) {

                            var color = shelfData[i].color;
                            var colorCode = shelfData[i].colorCode;
                            var process = shelfData[i].process;
                            var specification = shelfData[i].specification;
                            var total_remainingQuantity = shelfData[i].total_remainingQuantity;

                            now_UpdateProductId = shelfData[i].productId;

                            var sel_ProductCount = $('#quantity').val();

                            if (now_stockViewStatus == "修改") {
                                if (Number(sel_ProductCount) < (Number(now_UpdateProduct_inCount) - Number(total_remainingQuantity))) {
                                    $('#quantity').val((Number(now_UpdateProduct_inCount) - Number(total_remainingQuantity)));
                                }
                            }


                            if (i != 0) {
                                shelfDataTitleStr += ",";
                            }
                            shelfDataTitleStr += "[" + color + "_" + colorCode + "] " + specification + "_" + process + " 数量:" + total_remainingQuantity + "支";
                        }
                        //给shelfDataTitle 赋值
                        $('#shelfDataTitle').text(shelfDataTitleStr);
                        //初始化页面高度
                        initializeHeight();
                    }

                },
                error: function () {
                    alert('查询货架状态失败，请稍后再试。');
                }
            });
        }

    </script>

</body>
</html>